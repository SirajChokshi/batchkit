---
import { getCollection } from 'astro:content';
import Layout from './Layout.astro';
import TableOfContents from '../components/TableOfContents.svelte';

interface Props {
  title: string;
}

const { title } = Astro.props;
const docs = await getCollection('docs');
const sorted = docs.sort((a, b) => (a.data.order ?? 0) - (b.data.order ?? 0));
const currentPath = Astro.url.pathname;
---

<Layout title={`${title} - batchkit`}>
  <div class="pt-6 relative">
    <!-- Left sidebar - hidden on mobile, shown on lg+ -->
    <aside class="hidden lg:block fixed top-12 left-[max(0px,calc((100vw-80rem)/2))] w-56 h-[calc(100vh-3rem)] py-6 pr-8 overflow-y-auto">
      <div class="text-stone-400 text-xs tracking-widest pl-4 mb-3 uppercase font-mono">Pages</div>
      <nav class="flex flex-col gap-0.5">
        {sorted.map((doc) => (
          <a
            href={`/docs/${doc.id}`}
            class:list={[
              "text-sm font-mono px-4 py-2.5",
              currentPath.includes(doc.id) ? "text-stone-100 bg-stone-800" : "text-stone-500 hover:bg-stone-50 hover:text-stone-950"
            ]}
          >
            {doc.data.title}
          </a>
        ))}
      </nav>
    </aside>

    <!-- Mobile navigation - shown only on mobile -->
    <nav class="lg:hidden flex flex-wrap gap-2 mb-6 pb-4 border-b border-stone-700">
      {sorted.map((doc) => (
        <a
          href={`/docs/${doc.id}`}
          class:list={[
            "text-sm font-mono px-3 py-1.5",
            currentPath.includes(doc.id) ? "text-stone-100 bg-stone-800" : "text-stone-500 hover:bg-stone-50 hover:text-stone-950"
          ]}
        >
          {doc.data.title}
        </a>
      ))}
    </nav>

    <!-- Main content -->
    <article class="prose prose-invert max-w-none lg:ml-56 lg:pl-8 xl:mr-56 xl:pr-4 pb-32">
      <slot />
    </article>

    <!-- Right sidebar - hidden on mobile and tablet, shown on xl+ -->
    <aside class="hidden xl:block fixed top-12 right-[max(0px,calc((100vw-80rem)/2))] w-56 h-[calc(100vh-3rem)] py-6 pl-4 overflow-y-auto">
      <TableOfContents client:load />
    </aside>
  </div>
</Layout>

<script>
  function initCopyButtons() {
    document.querySelectorAll('.prose pre').forEach((pre) => {
      if (pre.querySelector('.copy-btn')) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      const btn = document.createElement('button');
      btn.className = 'copy-btn';
      btn.setAttribute('aria-label', 'Copy code');
      btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;

      btn.addEventListener('click', async () => {
        const code = pre.querySelector('code')?.textContent || pre.textContent || '';
        await navigator.clipboard.writeText(code);
        btn.classList.add('copied');
        btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;
        }, 1500);
      });

      wrapper.appendChild(btn);
    });
  }

  initCopyButtons();
  document.addEventListener('astro:page-load', initCopyButtons);
</script>
